import asyncio
import os
from typing import Annotated, Literal

from deepagents import async_create_deep_agent
from langchain_core.tools import tool
from langchain_tavily import TavilySearch
from langgraph.graph.ui import push_ui_message
from langgraph.prebuilt import InjectedState
from langgraph_sdk import get_client

from giga_agent.utils.jupyter import RunUploadFile, REPLUploader
from giga_agent.utils.llm import load_llm
from giga_agent.utils.messages import filter_tool_calls

llm = load_llm().bind(timeout=30).with_config(tags=["nostream"])


async def internet_search(
    query: str,
    max_results: int = 10,
    topic: Literal["general", "news", "finance"] = "general",
    include_raw_content: bool = False,
):
    """Функция поиска в интернете"""
    search = TavilySearch(
        include_raw_content=include_raw_content, max_results=max_results, topic=topic
    )
    result = await search.ainvoke({"query": query})
    return result


sub_research_prompt = """Вы — преданный своему делу исследователь. Ваша задача — проводить исследования, основанные на вопросах пользователей.

Проведите тщательное исследование и дайте пользователю подробный ответ на его вопрос.
Используй поиск, чтобы найти информацию и обязательно указывай источники со ссылками, найденными с использованием поиска!

Пользователю будет передан только ваш ОКОНЧАТЕЛЬНЫЙ ответ. Он не будет знать ничего, кроме вашего заключительного сообщения, поэтому ваш заключительный отчёт должен быть вашим заключительным сообщением!"""

research_sub_agent = {
    "name": "research-agent",
    "description": "Используется для более глубокого исследования вопросов. Давайте этому исследователю только одну тему за раз. Не передавайте ему несколько подвопросов. Вместо этого следует разбить большую тему на необходимые компоненты, а затем вызывать нескольких исследовательских агентов, по одному для каждого подвопроса.",
    "prompt": sub_research_prompt,
    "tools": ["internet_search"],
}

sub_critique_prompt = """Вы — назначенный редактор. Вам поручено написать рецензию на отчёт.

Отчёт можно найти в файле `final_report.md`.

Вопрос/тема для этого отчёта находятся в файле `question.txt`.

Пользователь может указать конкретные области для рецензирования отчёта. Предоставьте пользователю подробную рецензию на отчёт. Что можно улучшить.

Не пишите на сайт `final_report.md` самостоятельно.

Что нужно проверить:
— Убедитесь, что каждый раздел имеет правильное название.
— Убедитесь, что отчёт написан так, как если бы вы написали эссе или учебник — он должен быть насыщенным текстом, а не просто списком ключевых моментов!
— Убедитесь, что отчёт является полным. Если какие-либо абзацы или разделы короткие или в них отсутствуют важные детали, укажите на это. 
— Убедитесь, что отчёт охватывает ключевые области отрасли, обеспечивает общее понимание и не упускает важные моменты.
— Убедитесь, что отчёт глубоко анализирует причины, последствия и тенденции, предоставляя ценную информацию.
— Убедитесь, что отчёт точно соответствует теме исследования и отвечает на вопросы напрямую.
— Убедитесь, что отчёт имеет четкую структуру, написан понятным языком и легко читается.
- Убедитесь, что отчёт имеет источники в соответствующем разделе со ссылками, найденными с использованием поиска!"""

critique_sub_agent = {
    "name": "critique-agent",
    "description": "Используется для критики итогового отчёта. Предоставьте этому агенту информацию о том, как вы хотите, чтобы он критиковал отчёт.",
    "prompt": sub_critique_prompt,
}


# Prompt prefix to steer the agent to be an expert researcher
research_instructions = """Вы — опытный исследователь. Ваша задача — провести тщательное исследование и написать безупречный отчёт.

Первое, что вам следует сделать, — это записать исходный вопрос пользователя в файл `question.txt`, чтобы сохранить его.

Используйте research-agent для проведения глубокого исследования. Он предоставит подробные ответы на ваши вопросы/темы.

Когда вы сочтёте, что у вас достаточно информации для написания финального отчёта, запишите её в файл `final_report.md`.
При написании финального отчёта указывайте источники со ссылками, найденными с использованием поиска!

Вы можете вызвать critique-agent, чтобы получить критику финального отчёта. После этого (при необходимости) вы можете продолжить исследование и отредактировать файл `final_report.md`. Вы можете делать это столько раз, сколько захотите, пока не будете удовлетворены результатом.

Вот инструкции по написанию итогового отчёта:

<report_instructions>

ВАЖНО: Убедитесь, что ответ написан на том же языке, что и сообщения от человека! Если вы составляете план задач, используя write_todos, укажите в нём, на каком языке должен быть отчёт, чтобы не забыть!
Примечание: язык отчёта должен быть тем же, на котором написан ВОПРОС, а не языком/страной, о которых идёт речь.

Пожалуйста, создайте подробный отчёт с исследованием, который:
1. Хорошо структурирован с правильными заголовками (# для заголовка, ## для разделов, ### для подразделов)
2. Содержит конкретные факты и выводы из исследования
3. Ссылается на соответствующие источники в формате [Title](URL)
4. Содержит сбалансированный и глубокий анализ. Будьте максимально подробным и включите всю информацию, относящуюся к общему исследовательскому вопросу. Люди обращаются к вам за глубокими исследованиями и ожидают подробных, исчерпывающих ответов. 
5. Включает раздел «Источники» в конце со всеми ссылками.

Вы можете структурировать свой отчёт различными способами. Вот несколько примеров:

Чтобы ответить на вопрос, требующий сравнения двух объектов, вы можете структурировать свой отчёт следующим образом:
1/ Введение
2/ Обзор темы A
3/ Обзор темы B
4/ Сравнение между A и B
5/ Заключение

Чтобы ответить на вопрос, требующий представления списка объектов, вам может понадобиться только один раздел, представляющий собой весь список.
1/ Список объектов или таблица объектов
Или вы можете оформить каждый объект списка в отдельный раздел отчёта. Если вам нужно составить список, введение или заключение не требуются.
1/ Пункт 1
2/ Пункт 2
3/ Пункт 3

Чтобы ответить на вопрос, требующий подведения итогов по теме, составления отчёта или обзора, вы можете структурировать свой отчёт следующим образом:
1/ Обзор темы
2/ Концепция 1
3/ Концепция 2
4/ Концепция 3
5/ Заключение

Если вы считаете, что можете ответить на вопрос одним разделом, вы тоже можете это сделать! 
1/ ответ

ПОМНИТЕ: Раздел — это ОЧЕНЬ расплывчатое и свободное понятие. Вы можете структурировать свой отчёт любым удобным для вас способом, в том числе способами, не перечисленными выше!
Убедитесь, что ваши разделы связны и понятны читателю.

Для каждого раздела отчёта выполните следующие действия:
- Используйте простой и понятный язык.
- Используйте ## для заголовков разделов (формат Markdown) для каждого раздела отчёта.
- НИКОГДА не называйте себя автором отчёта. Отчёт должен быть профессиональным, без самореферентов.
- Не указывайте в отчёте, чем вы занимаетесь. Просто напишите отчёт без каких-либо собственных комментариев.
- Каждый раздел должен быть достаточно длинным, чтобы дать полный ответ на вопрос, используя собранную вами информацию. Ожидается, что разделы будут довольно длинными и подробными. Вы пишете глубокий исследовательский отчёт, и пользователи ожидают исчерпывающего ответа.
- Используйте маркированные списки для перечисления информации, когда это уместно, но по умолчанию пишите в формате абзацев.

ПОМНИТЕ:
Краткое содержание и исследование могут быть на английском языке, но вам необходимо перевести эту информацию на правильный язык при написании окончательного ответа.
Убедитесь, что окончательный ответ составлен на ТОМ ЖЕ языке, что и сообщения в истории сообщений.

Оформите отчёт в понятной разметке Markdown с правильной структурой и включите ссылки на источники, где это необходимо.

Обязательно указывай в отчёте источники со ссылками, найденными с использованием поиска!

<Правила цитирования>
- Присвойте каждому уникальному URL-адресу отдельный номер ссылки в тексте.
- Заканчивайте текст тегом ###. Источники перечисляются с соответствующими номерами.
- ВАЖНО: Нумеруйте источники последовательно без пробелов (1,2,3,4...) в окончательном списке независимо от выбранных источников.
- Каждый источник должен быть отдельной строкой в ​​списке, чтобы в разметке Markdown он отображался как список.
- Пример формата:
[1] Название источника: URL
[2] Название источника: URL
- Ссылки крайне важны. Обязательно включите их и уделите особое внимание правильному оформлению. Пользователи часто будут использовать эти ссылки для поиска дополнительной информации.
</Правила цитирования>
</report_instructions>

У вас есть доступ к нескольким инструментам.

## `internet_search`

Используйте это для запуска интернет-поиска по заданному запросу. Вы можете указать количество результатов, тему и необходимость включения исходного контента.
"""

# Create the agent
agent = async_create_deep_agent(
    tools=[internet_search],
    instructions=research_instructions,
    subagents=[critique_sub_agent, research_sub_agent],
    model=llm,
).with_config({"recursion_limit": 1000})


@tool
async def researcher_agent(question: str, state: Annotated[dict, InjectedState] = None):
    """Проводит исследование и создает на его основе отчёт по запросу пользователя"""

    last_mes = filter_tool_calls(state["messages"][-1])
    client = get_client(url=os.getenv("LANGGRAPH_API_URL", "http://0.0.0.0:2024"))
    thread = await client.threads.create()
    thread_id = thread["thread_id"]

    result_state = {}
    async for chunk in client.runs.stream(
        thread_id=thread_id,
        assistant_id="researcher",
        input={
            "messages": state["messages"][:-1]
            + [
                last_mes,
                ("user", question),
            ],
        },
        stream_mode=["values"],
        on_disconnect="cancel",
        config={"configurable": {"thread_id": thread_id}},
    ):
        if chunk.event == "values":
            result_state = chunk.data
    if "files" in result_state:
        if "final_report.md" in result_state["files"]:
            final_report = result_state["files"]["final_report.md"]
        else:
            final_report = result_state["messages"][-1].content
    else:
        final_report = result_state["messages"][-1].content

    if not final_report:
        return {
            "message": f"Отчёт не сгенерировался, попробуй вызвать агента ещё раз.",
        }
    uploader = REPLUploader()
    upload_files = [
        RunUploadFile(
            path="research_result.md",
            file_type="text",
            content=final_report,
        )
    ]
    upload_resp = await uploader.upload_run_files(upload_files, thread_id=thread_id)
    upload_resp = upload_resp[0]

    return {
        "message": f'В результате выполнения был получен следующий отчёт и сохранен в файле: {upload_resp["path"]}. НЕ ВЫВОДИ отчет сам, вместо этого покажи его пользователю через вложение "![alt-описание](attachment:{upload_resp["path"]})" ',
        "text": final_report,
    }


async def chat_with_agent(message):
    async for s in agent.astream({"messages": [{"role": "user", "content": message}]}):
        print(s)


if __name__ == "__main__":
    message = "что такое gigachain"
    # message = "чем LangChain отличается от GigaChain"
    asyncio.run(chat_with_agent(message))
