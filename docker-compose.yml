volumes:
    aegra-data:
        driver: local
services:
    langgraph-redis:
        image: redis:6
        healthcheck:
            test: redis-cli ping
            interval: 5s
            timeout: 1s
            retries: 5
    aegra-postgres:
        image: postgres:16
        environment:
            POSTGRES_DB: postgres
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
        volumes:
            - aegra-data:/var/lib/postgresql/data
        healthcheck:
            test: pg_isready -U postgres
            start_period: 10s
            timeout: 1s
            retries: 5
            interval: 5s
    langgraph-api:
        build:
            context: ./backend/graph
        depends_on:
            aegra-postgres:
                condition: service_healthy
        image: giga_agent_aegra
        pull_policy: never
        env_file:
            - .docker.env
        environment:
            REDIS_URI: redis://langgraph-redis:6379
            DATABASE_URL: postgresql+asyncpg://postgres:postgres@aegra-postgres:5432/postgres
            AUTH_TYPE: noop
            JUPYTER_CLIENT_API: http://repl:9090
            JUPYTER_UPLOAD_API: http://upload_server:9092
            TOOL_CLIENT_API: http://tool_server:9091
        command: >
            sh -c "
              echo 'Running database migrations...' &&
              uv run alembic upgrade head &&
              echo 'Starting Aegra server...' &&
              uv run uvicorn src.agent_server.main:app --host 0.0.0.0 --port 8000
            "
    repl:
        working_dir: /
        restart: always
        build:
            context: ./backend/repl
        image: repl:latest
        pull_policy: never
        user: root
        command: sh -c "chown -R jupyter:jupyter /home/jupyter /kernel_states /runs && exec su -s /bin/bash -c 'uv run uvicorn app.main:app --host 0.0.0.0 --port 9090' jupyter"
        environment:
            PLOTLY_RENDERER: plotly_mimetype
            MAX_KERNEL_LIVE: 300
            FILES_DIR: /files
            STATE_DIR: /kernel_states
        volumes:
            - ./kernel_states/:/kernel_states/
            - ./files/:/files/:ro
            - ./data/jupyter/:/home/jupyter/
            - ./data/runs/:/runs/
    upload_server:
        working_dir: /
        restart: always
        image: repl:latest
        user: root
        pull_policy: never
        depends_on:
            - repl
        command: uv run uvicorn app.upload_server:app --host 0.0.0.0 --port 9092
        env_file:
            - .docker.env
        environment:
            PLOTLY_RENDERER: plotly_mimetype
            MAX_KERNEL_LIVE: 300
            FILES_DIR: /files
            STATE_DIR: /kernel_states
            GIGA_AGENT_API: http://giga_agent_server:8822
        volumes:
            - ./files/:/files/:rw
            - ./data/runs:/runs/:rw
    tool_server:
        working_dir: /app
        restart: always
        image: giga_agent_aegra
        pull_policy: never
        command: uv run uvicorn giga_agent.tool_server.tool_server:app --host 0.0.0.0 --port 9091
        env_file:
            - .docker.env
        entrypoint: []
        environment:
            JUPYTER_CLIENT_API: http://repl:9090
            TOOL_CLIENT_API: http://tool_server:9091
            JUPYTER_UPLOAD_API: http://upload_server:9092
    giga_agent_server:
        working_dir: /app
        restart: always
        image: giga_agent_aegra
        pull_policy: never
        command: uv run uvicorn giga_agent.tasks_app:app --host 0.0.0.0 --port 8822
        env_file:
            - .docker.env
        entrypoint: [ ]
        environment:
            JUPYTER_CLIENT_API: http://repl:9090
            LANGGRAPH_API_URL: http://langgraph-api:8000
    frontend:
        build:
            context: ./front
            dockerfile: Dockerfile
            args:
                VITE_LANGCONNECT_API_URL: ${LANGCONNECT_API_URL}
                VITE_LANGCONNECT_API_SECRET_TOKEN: ${LANGCONNECT_API_SECRET_TOKEN}
                VITE_MCP_PROXY_URL: ${MCP_PROXY_URL}
        env_file:
            - .docker.env
        volumes:
            - ./files/:/files/:ro
            - ./data/jupyter:/home/jupyter/:ro
            - ./data/runs:/runs/:ro
            - ./front/nginx.conf:/etc/nginx/nginx.conf:ro
        ports:
            - "8502:80"
        ulimits:
            nofile:
                soft: 65536
                hard: 65536
        depends_on:
            langgraph-api:
                condition: service_started
            repl:
                condition: service_started
            tool_server:
                condition: service_started